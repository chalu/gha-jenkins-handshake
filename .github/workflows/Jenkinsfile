pipeline {
  agent {
    label 'main'
  }

  environment {
    BUILD_SECRETS = credentials('sensibill-api-build-secrets')
    NPM_TOKEN = sh(returnStdout: true, script: '#!/bin/sh -e\necho $BUILD_SECRETS | grep NPM_TOKEN | cut -d "=" -f 2')
  }

  stages {

    stage('Build Artifact') {
      steps {
        sh "docker run --name sb-mongo -d mongo:latest"
      }
    }

    stage('Deploy to TESTING') {
      script {
          env.ghaPayload = {
            "environment": "testing"
          }
      }

      steps {
        httpRequest(url: 'https://postman-echo.com/post', httpMode: 'POST', requestBody: "${env.ghaPayload}", acceptType: 'APPLICATION_JSON', contentType: 'APPLICATION_JSON')
      }
    }
    
  }

  post {
    always {
      sh "docker container sb-mongo stop"

      cleanWs()
    }
  }
}
